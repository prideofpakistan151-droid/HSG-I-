<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Details - Hostel Bill Manager Pro</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/bill-detail.css">
    <link rel="stylesheet" href="styles/dark-mode.css">
    <link rel="stylesheet" href="styles/animations.css">
</head>
<body class="light-theme">
    <div class="container">
        <header class="page-header">
            <button class="back-btn" onclick="goBack()">â†</button>
            <h1 id="billDetailTitle">Bill Details</h1>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="theme-icon">ğŸŒ™</span>
            </button>
        </header>

        <!-- Bill Header -->
        <div class="bill-header-card">
            <div class="bill-basic-info">
                <div class="bill-icon" id="billIcon">ğŸ“</div>
                <div class="bill-info">
                    <h2 id="billName">Loading...</h2>
                    <div class="bill-meta">
                        <span class="meta-item" id="billDate">ğŸ“… ...</span>
                        <span class="meta-item" id="billCategory">ğŸ·ï¸ ...</span>
                        <span class="meta-item" id="billAmount">ğŸ’° ...</span>
                    </div>
                </div>
            </div>
            
            <div class="bill-actions">
                <button class="btn-sm" onclick="editBill()" title="Edit Bill">
                    âœï¸ Edit
                </button>
                <button class="btn-sm" onclick="shareBill()" title="Share Bill">
                    ğŸ“¤ Share
                </button>
                <button class="btn-sm btn-danger" onclick="deleteBill()" title="Delete Bill">
                    ğŸ—‘ï¸ Delete
                </button>
            </div>
        </div>

        <!-- Bill Description -->
        <div class="description-card" id="descriptionCard" style="display: none;">
            <h3>ğŸ“ Description</h3>
            <p id="billDescription"></p>
        </div>

        <!-- Quick Summary -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-icon">ğŸ“Š</div>
                <div class="summary-info">
                    <div class="summary-value" id="entriesCount">0</div>
                    <div class="summary-label">Entries</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">ğŸ‘¥</div>
                <div class="summary-info">
                    <div class="summary-value" id="participantsCount">0</div>
                    <div class="summary-label">People</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">ğŸ’°</div>
                <div class="summary-info">
                    <div class="summary-value" id="totalAmount">â‚¹0</div>
                    <div class="summary-label">Total</div>
                </div>
            </div>
        </div>

        <!-- Expense Entries -->
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ’¸ Expense Entries</h3>
                <button class="btn-sm" onclick="exportEntries()">
                    ğŸ“¤ Export
                </button>
            </div>
            
            <div id="entriesList" class="entries-list">
                <!-- Entries will be loaded here -->
            </div>
        </div>

        <!-- Participant Breakdown -->
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ‘¥ Participant Breakdown</h3>
            </div>
            <div id="participantBreakdown" class="breakdown-list">
                <!-- Breakdown will be loaded here -->
            </div>
        </div>

        <!-- Final Settlement -->
        <div class="section-card settlement-card">
            <div class="section-header">
                <h3>ğŸ¯ Final Settlement</h3>
                <button class="btn-sm" onclick="recalculateSettlement()">
                    ğŸ”„ Recalculate
                </button>
            </div>
            <div id="settlementDetails" class="settlement-details">
                <!-- Settlement details will be loaded here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-primary" onclick="editBill()">
                <span>âœï¸</span> Edit Bill
            </button>
            <button class="btn-secondary" onclick="duplicateBill()">
                <span>ğŸ“‹</span> Duplicate
            </button>
            <button class="btn-secondary" onclick="shareBill()">
                <span>ğŸ“¤</span> Share Bill
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading bill details...</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ—‘ï¸ Delete Bill</h3>
                <button class="close-modal" onclick="closeDeleteModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this bill? This action cannot be undone.</p>
                <div class="bill-preview">
                    <strong id="deleteBillName">Bill Name</strong>
                    <div class="bill-preview-meta">
                        <span id="deleteBillDate">Date</span>
                        <span id="deleteBillAmount">Amount</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-danger" onclick="confirmDelete()">
                    ğŸ—‘ï¸ Delete Bill
                </button>
                <button class="btn-secondary" onclick="closeDeleteModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme.js"></script>
    <script>
        let currentBill = null;
        let currentBillId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentBillId = urlParams.get('id');
            
            if (currentBillId) {
                loadBillDetail(currentBillId);
            } else {
                showNotification('No bill ID provided', 'error');
                setTimeout(() => navigateTo('previous-bills.html'), 2000);
            }
        });

        function loadBillDetail(billId) {
            showLoading();
            
            setTimeout(() => {
                const bill = getBillById(billId);
                
                if (bill) {
                    currentBill = bill;
                    renderBillDetails();
                    hideLoading();
                } else {
                    showNotification('Bill not found', 'error');
                    hideLoading();
                    setTimeout(() => navigateTo('previous-bills.html'), 2000);
                }
            }, 500);
        }

        function renderBillDetails() {
            if (!currentBill) return;

            // Basic Info
            document.getElementById('billDetailTitle').textContent = currentBill.name;
            document.getElementById('billName').textContent = currentBill.name;
            document.getElementById('billDate').textContent = `ğŸ“… ${formatDate(currentBill.date)}`;
            document.getElementById('billCategory').textContent = `ğŸ·ï¸ ${currentBill.category}`;
            document.getElementById('billAmount').textContent = `ğŸ’° â‚¹${currentBill.totalAmount?.toFixed(2) || '0.00'}`;
            document.getElementById('billIcon').textContent = getCategoryIcon(currentBill.category);

            // Description
            const descriptionCard = document.getElementById('descriptionCard');
            const billDescription = document.getElementById('billDescription');
            if (currentBill.description) {
                billDescription.textContent = currentBill.description;
                descriptionCard.style.display = 'block';
            } else {
                descriptionCard.style.display = 'none';
            }

            // Summary Cards
            document.getElementById('entriesCount').textContent = currentBill.entries?.length || 0;
            document.getElementById('totalAmount').textContent = `â‚¹${currentBill.totalAmount?.toFixed(2) || '0.00'}`;
            
            // Participants count
            const participants = new Set();
            if (currentBill.entries) {
                currentBill.entries.forEach(entry => {
                    if (entry.participants) {
                        entry.participants.split('').forEach(code => participants.add(code));
                    }
                });
            }
            document.getElementById('participantsCount').textContent = participants.size;

            // Render entries
            renderEntries();

            // Render participant breakdown
            renderParticipantBreakdown();

            // Render settlement
            renderSettlement();

            // Update delete modal
            document.getElementById('deleteBillName').textContent = currentBill.name;
            document.getElementById('deleteBillDate').textContent = formatDate(currentBill.date);
            document.getElementById('deleteBillAmount').textContent = `â‚¹${currentBill.totalAmount?.toFixed(2) || '0.00'}`;
        }

        function renderEntries() {
            const entriesList = document.getElementById('entriesList');
            
            if (!currentBill.entries || currentBill.entries.length === 0) {
                entriesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¸</div>
                        <p>No expense entries in this bill</p>
                    </div>
                `;
                return;
            }

            entriesList.innerHTML = currentBill.entries.map(entry => {
                const participants = entry.participants ? 
                    entry.participants.split('').map(code => 
                        `<span class="participant-tag">${nameMap[code]?.avatar} ${nameMap[code]?.name}</span>`
                    ).join('') : 'No participants';
                
                return `
                    <div class="entry-item">
                        <div class="entry-main">
                            <div class="entry-amount">â‚¹${entry.price.toFixed(2)}</div>
                            <div class="entry-details">
                                <div class="entry-description">${entry.description || 'No description'}</div>
                                <div class="entry-participants">${participants}</div>
                                <div class="entry-meta">
                                    ${entry.shares ? 'Custom split' : 'Equal split'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderParticipantBreakdown() {
            const breakdownList = document.getElementById('participantBreakdown');
            
            if (!currentBill.totals || Object.keys(currentBill.totals).length === 0) {
                breakdownList.innerHTML = `
                    <div class="empty-state">
                        <p>No participant data available</p>
                    </div>
                `;
                return;
            }

            let html = '';
            Object.entries(currentBill.totals).forEach(([code, amount]) => {
                if (amount !== 0) {
                    const person = nameMap[code];
                    html += `
                        <div class="breakdown-item">
                            <div class="participant-info">
                                <span class="participant-avatar" style="background: ${person.color}">
                                    ${person.avatar}
                                </span>
                                <span class="participant-name">${person.name}</span>
                            </div>
                            <div class="participant-amount ${amount < 0 ? 'negative' : 'positive'}">
                                ${amount < 0 ? 'Owes' : 'Paid'}: â‚¹${Math.abs(amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                }
            });

            breakdownList.innerHTML = html || `
                <div class="empty-state">
                    <p>All participants are settled up</p>
                </div>
            `;
        }

        function renderSettlement() {
            const settlementDetails = document.getElementById('settlementDetails');
            
            if (!currentBill.finalTotals) {
                settlementDetails.innerHTML = `
                    <div class="empty-state">
                        <p>No settlement calculated for this bill</p>
                        <button class="btn-sm" onclick="calculateSettlement()">
                            Calculate Settlement
                        </button>
                    </div>
                `;
                return;
            }

            const settlements = calculateOptimalSettlements(currentBill.finalTotals);
            
            if (settlements.length === 0) {
                settlementDetails.innerHTML = `
                    <div class="settlement-message success">
                        <div class="message-icon">âœ…</div>
                        <h4>All Settled Up!</h4>
                        <p>No money needs to change hands. Everything is balanced!</p>
                    </div>
                `;
            } else {
                let html = '<div class="settlements-list">';
                
                settlements.forEach(settlement => {
                    html += `
                        <div class="settlement-item">
                            <div class="settlement-from">
                                <span class="avatar">${nameMap[settlement.from]?.avatar}</span>
                                ${nameMap[settlement.from]?.name}
                            </div>
                            <div class="settlement-arrow">â†’</div>
                            <div class="settlement-to">
                                <span class="avatar">${nameMap[settlement.to]?.avatar}</span>
                                ${nameMap[settlement.to]?.name}
                            </div>
                            <div class="settlement-amount">â‚¹${settlement.amount.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add summary
                const totalAmount = currentBill.totalAmount || 0;
                html += `
                    <div class="settlement-summary">
                        <div class="summary-row">
                            <span>Total Bill Amount:</span>
                            <span>â‚¹${totalAmount.toFixed(2)}</span>
                        </div>
                        <div class="summary-row highlight">
                            <span>Pay to Shah jee:</span>
                            <span>â‚¹${totalAmount.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                
                settlementDetails.innerHTML = html;
            }
        }

        function calculateSettlement() {
            if (!currentBill.totals) {
                showNotification('No totals data available', 'error');
                return;
            }

            currentBill.finalTotals = {...currentBill.totals};
            currentBill.settlements = calculateOptimalSettlements(currentBill.totals);
            
            // Save the updated bill
            saveBill(currentBill);
            renderSettlement();
            showNotification('Settlement calculated successfully', 'success');
        }

        function recalculateSettlement() {
            calculateSettlement();
        }

        function editBill() {
            if (currentBill) {
                sessionStorage.setItem('currentBill', JSON.stringify(currentBill));
                navigateTo('calculator.html');
            }
        }

        function duplicateBill() {
            if (currentBill) {
                const duplicatedBill = {
                    ...currentBill,
                    id: Date.now().toString(),
                    name: `${currentBill.name} (Copy)`,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                delete duplicatedBill.finalTotals;
                delete duplicatedBill.settlements;
                
                if (saveBill(duplicatedBill)) {
                    showNotification('Bill duplicated successfully', 'success');
                    setTimeout(() => {
                        navigateTo(`bill-detail.html?id=${duplicatedBill.id}`);
                    }, 1000);
                }
            }
        }

        function shareBill() {
            if (!currentBill) return;

            const billData = {
                title: currentBill.name,
                date: currentBill.date,
                total: currentBill.totalAmount,
                entries: currentBill.entries || [],
                totals: currentBill.totals || {},
                settlements: currentBill.settlements || calculateOptimalSettlements(currentBill.totals || {})
            };
            
            let shareText = `ğŸ’¸ ${billData.title}\n`;
            shareText += `Date: ${formatDate(billData.date)}\n`;
            shareText += `Total: â‚¹${billData.total.toFixed(2)}\n\n`;
            
            if (billData.entries.length > 0) {
                shareText += "Expenses:\n";
                billData.entries.forEach(entry => {
                    shareText += `â€¢ â‚¹${entry.price.toFixed(2)} - ${entry.description || 'No description'}\n`;
                });
                shareText += "\n";
            }
            
            shareText += "Settlements:\n";
            if (billData.settlements.length === 0) {
                shareText += "âœ… All settled up!\n";
            } else {
                billData.settlements.forEach(settlement => {
                    shareText += `â€¢ ${nameMap[settlement.from]?.name} â†’ ${nameMap[settlement.to]?.name}: â‚¹${settlement.amount.toFixed(2)}\n`;
                });
            }
            
            shareText += `\nShared via Hostel Bill Manager Pro`;
            
            // Use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: billData.title,
                    text: shareText
                }).catch(error => {
                    console.log('Sharing failed:', error);
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Bill details copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Bill details copied to clipboard!', 'success');
            });
        }

        function exportEntries() {
            if (!currentBill.entries || currentBill.entries.length === 0) {
                showNotification('No expenses to export', 'warning');
                return;
            }
            
            const csv = convertEntriesToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `${currentBill.name.replace(/\s+/g, '_')}_expenses.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Expenses exported as CSV', 'success');
        }

        function convertEntriesToCSV() {
            let csv = 'Amount,Description,Participants,Date\n';
            
            currentBill.entries.forEach(entry => {
                const participants = entry.participants ? 
                    entry.participants.split('').map(code => 
                        nameMap[code]?.name || code
                    ).join('; ') : '';
                
                csv += `"${entry.price}","${entry.description || ''}","${participants}","${entry.createdAt}"\n`;
            });
            
            return csv;
        }

        function deleteBill() {
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        function confirmDelete() {
            if (currentBill) {
                if (deleteBillById(currentBill.id)) {
                    showNotification('Bill deleted successfully', 'success');
                    closeDeleteModal();
                    setTimeout(() => navigateTo('previous-bills.html'), 1000);
                }
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                'food': 'ğŸ•',
                'groceries': 'ğŸ›’',
                'utilities': 'âš¡',
                'rent': 'ğŸ ',
                'transport': 'ğŸš—',
                'entertainment': 'ğŸ¬',
                'other': 'ğŸ“¦'
            };
            return icons[category] || 'ğŸ“';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
